stages:
  - Build
  - Publish

Build:
  when: manual
  stage: Build
  image:
    name: containers.harderthanitneedstobe.com/kaniko-ci:latest
  tags:
    - k8s:shared
    - arch:amd64
  script:
    - ./image.sh build

Push:
  secrets:
    config.json:
      vault: containers/push/docker-config.json@pipelines/harderthanitneedstobe.com
  only:
    refs:
      - main
  stage: Publish
  variables:
    DOCKER_CONFIG: "${CI_PROJECT_DIR}.tmp"
  image:
    name: containers.harderthanitneedstobe.com/kaniko-ci:latest
  tags:
    - k8s:shared
    - arch:amd64
  script:
    - env
    - ./image.sh push
